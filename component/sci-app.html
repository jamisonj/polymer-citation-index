<dom-module id="sci-app">
    <link rel="import" href="../bower_components/polymer/polymer.html">
    <link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
    <link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
    <link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
    <link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
    <link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

    <link rel="import" href="sci-about.html">
    <link rel="import" href="sci-director.html">
    <link rel="import" href="sci-drawer-pages.html">

    <link rel="import" type="css" href="../css/sci-app.css">

    <style is="custom-style" include="iron-flex iron-flex-alignment">
    </style>

    <template>
        <!-- NEEDSWORK: replace static JSON file with call to server to load from database -->
        <iron-ajax auto
            url="../model/volumes.json"
            handle-as="json"
            last-response="{{volumes}}"
            debounce-duration="300">
        </iron-ajax>

        <paper-drawer-panel class="flex" drawer-width="380px">
            <!-- Here's the drawer, and it automatically hides away for narrow displays -->
            <paper-header-panel drawer class="drawerback">
                <paper-toolbar class="drawer-head medium-tall">
                    <div class="flex">LDS Scripture Citation Index</div>
                    <paper-tabs selected="{{selected}}" class="bottom self-end" on-tap="tabSelected">
                        <paper-tab>SCRIPTURES</paper-tab>
                        <paper-tab>INDEX</paper-tab>
                        <paper-tab>CONTENTS</paper-tab>
                        <paper-tab>SPEAKERS</paper-tab>
                    </paper-tabs>
                </paper-toolbar>
                <sci-drawer-pages volumes="{{volumes}}" selected="{{selected}}" class="flex"></sci-drawer-pages>
            </paper-header-panel>

            <!-- Here's the main content panel -->
            <paper-header-panel main>
                <paper-toolbar class="medium-tall">
                    <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
                    <div class="flex site-title">About the LDS Scripture Citation Index</div>
                    <paper-icon-button icon="search"></paper-icon-button>
                    <div class="bottom">
                        &nbsp; <b>Note:</b> the real LDS Scripture Citation Index is at
                        <a href="http://scriptures.byu.edu" style="color: white">scriptures.byu.edu</a>
                    </div>
                </paper-toolbar>
                <sci-about></sci-about>
            </paper-header-panel>
        </paper-drawer-panel>
        <sci-director route="{{route}}"></sci-director>
        <iron-ajax id="docAjax" url="" handle-as="document"></iron-ajax>
    </template>
    <script>
        Polymer({
            is: 'sci-app',

            properties: {
                route: {
                    type: String,
                    notify: true,
                    observer: 'routeChanged'
                },

                previousSelected: {
                    type: String,
                    value: 'SCRIPTURES'
                },

                selected: {
                    type: Number,
                    value: 0,
                    notify: true
                }
            },

            ready: function () {
                var self = this;

                self.$.docAjax.addEventListener('response', function (response) {
                    try {
                        self.async(function () {
                            var i;
                            var l;
                            var links = response.detail.response.head.querySelectorAll('link');

                            for (i = 0; i <= links.length - 1; i++) {
                                if (!window.document.head.innerHTML.indexOf(links[i].href.toLowerCase()) != -1) {
                                    l = document.createElement('link');
                                    l.rel = 'import';
                                    l.href = links[i].href.toLowerCase();
                                    document.head.appendChild(l);
                                }
                            }

                            l = document.createElement('div');
                            l.innerHTML = response.detail.response.body.innerHTML;
                            self.$.main.innerHTML = '';
                            self.$.main.appendChild(l);
                        }, 0);
                    } catch (e) {
                        // Ignore
                    }
                });
            },

            routeChanged: function (newValue, oldValue) {
                // NEEDSWORK: finish adding routing facilities
                var page = newValue.replace('!', '');
                var params = page.split('?')[1];
                var pageName = page.split('?')[0];

                if (pageName === '') {
                    pageName = 'home';
                }

                this.$.docAjax.url = 'app/pages/' + pageName + '/' + pageName + '.html?' + params;
                this.$.docAjax.generateRequest();
            },

            tabSelected: function (event) {
                // When the user selects a tab that is already displayed, navigate
                // to the home panel of that tab (if not already at the home panel).
                var tabName = event.target.textContent.trim();
                var drawer;
                
                if (this.previousSelected === tabName) {
                    drawer = document.querySelector('sci-drawer-pages');
                    drawer.navigateHome(tabName);
                }

                this.previousSelected = tabName;
            }
        });
    </script>
</dom-module>
